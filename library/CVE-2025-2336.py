"""
CVE-2025-2336 Vulnerability Detection Script
AngularJS General Web Application Vulnerability
"""

import requests
import json
import time
from urllib.parse import urljoin

def scan(session, target_url):
    """
    掃描 CVE-2025-2336 弱點
    一般網路應用程式安全弱點檢測
    """
    result = {
        'vulnerable': False,
        'evidence': '',
        'description': 'CVE-2025-2336: AngularJS 一般網路應用程式安全弱點',
        'remediation': '應用最新的安全補丁，更新到最新版本，實施適當的輸入驗證和輸出編碼'
    }
    
    try:
        print("      [檢測] 正在檢查 CVE-2025-2336 一般網路應用程式弱點...")
        
        # 檢測 AngularJS 應用程式
        response = session.get(target_url, timeout=30)
        
        angular_indicators = [
            'angular.js',
            'angular.min.js',
            'ng-app',
            'ng-controller',
            'angular.module'
        ]
        
        if not any(indicator in response.text.lower() for indicator in angular_indicators):
            result['evidence'] = "未檢測到 AngularJS 應用程式"
            return result
        
        print("      [檢測] 發現 AngularJS 應用程式，開始安全檢測...")
        
        # 測試常見安全弱點
        test_endpoints = [
            '/api/test',
            '/api/data',
            '/api/user',
            '/test',
            '/data',
            '/info'
        ]
        
        # 測試 SQL 注入
        sql_payloads = [
            "' OR '1'='1",
            "' OR 1=1--",
            "admin'--",
            "'; DROP TABLE users; --"
        ]
        
        for endpoint in test_endpoints:
            for payload in sql_payloads:
                try:
                    response = session.get(
                        urljoin(target_url, endpoint),
                        params={'id': payload, 'search': payload},
                        timeout=15
                    )
                    
                    # 檢查 SQL 錯誤指示
                    sql_errors = [
                        'mysql_fetch_array',
                        'sql syntax',
                        'ora-00933',
                        'postgresql error'
                    ]
                    
                    if any(error in response.text.lower() for error in sql_errors):
                        result['vulnerable'] = True
                        result['evidence'] = f"在端點 {endpoint} 發現 SQL 注入弱點，負載: {payload}"
                        return result
                        
                except:
                    continue
        
        # 測試 XSS
        xss_payload = "<script>alert('CVE-2025-2336')</script>"
        for endpoint in test_endpoints:
            try:
                response = session.get(
                    urljoin(target_url, endpoint),
                    params={'q': xss_payload},
                    timeout=15
                )
                
                if xss_payload in response.text:
                    result['vulnerable'] = True
                    result['evidence'] = f"在端點 {endpoint} 發現 XSS 弱點"
                    return result
                    
            except:
                continue
        
        # 測試目錄遍歷
        traversal_payload = "../../../../etc/passwd"
        try:
            response = session.get(
                urljoin(target_url, '/download'),
                params={'file': traversal_payload},
                timeout=15
            )
            
            if 'root:' in response.text or '/bin/bash' in response.text:
                result['vulnerable'] = True
                result['evidence'] = f"發現目錄遍歷弱點，可讀取系統檔案"
                return result
                
        except:
            pass
        
        # 測試未授權存取
        admin_endpoints = ['/admin', '/admin/', '/admin/dashboard']
        for endpoint in admin_endpoints:
            try:
                response = session.get(urljoin(target_url, endpoint), timeout=15)
                
                if response.status_code == 200:
                    admin_indicators = ['admin', 'dashboard', 'users', 'settings']
                    if any(indicator in response.text.lower() for indicator in admin_indicators):
                        result['vulnerable'] = True
                        result['evidence'] = f"發現未授權存取弱點: {endpoint}"
                        return result
                        
            except:
                continue
        
        result['evidence'] = "完成 CVE-2025-2336 安全檢測，未發現明顯弱點"
        
    except Exception as e:
        result['evidence'] = f"掃描過程中發生錯誤: {str(e)}"
    
    return result